<!DOCTYPE html>
<html>

<head>
  <title>曲线</title>
  <script src="https://unpkg.com/react@17/umd/react.development.js"></script>
  <script src="https://unpkg.com/react-dom@17/umd/react-dom.development.js"></script>
  <script src="https://unpkg.com/babel-standalone@6/babel.min.js"></script>
  <script src="https://cdn.bootcdn.net/ajax/libs/echarts/5.2.2/echarts.min.js"></script>
  <script type='text/javascript' src='./data/xData.js'></script>
  <script type='text/javascript' src='./data/productNameList.js'></script>
  <style>
    .dropdown-menu {
      max-height: 200px;
      overflow-y: auto;
    }
  </style>
</head>

<body>
  <div id="root"></div>
  <script type="text/babel">
    class Dropdown extends React.Component {
      constructor(props) {
        super(props);
        this.state = {
          inputValue: null,// 输入框的值
          titleKey: null,// 被选中的echarts的标题
          selectList: [],// 下拉框的内容
          filteredSelectList: [],// 过滤后的下拉框内容
          showOptions: false,// 是否显示下拉框
          showCharts: false,// 是否显示曲线图
          xData: [],// 横坐标内容
          yData: [],// 纵坐标内容
          //allData: {},// 所有数据大集合
          source: {}// 当前1个产品的数据源
        };
      }

      componentWillMount() {
        //this.state.allData = { "xData": ["2024-05-25", "2024-05-26", "2024-05-27", "2024-05-28"], "source": [{ "sourceName": "jiaGuo", "sourceData": [{ "productName": "兰蔻清爽防晒", "yData": [null, 1.43, 5.23, 2.11] }, { "productName": "科颜氏大高保湿面霜", "yData": [5.43, null, 2.23, 1.11] }] }, { "sourceName": "xiaoChen", "sourceData": [{ "productName": "兰蔻清爽防晒", "yData": [null, 1.03, 6.23, 1.11] }, { "productName": "科颜氏大高保湿面霜", "yData": [null, 1.43, 5.23, 2.11] }, { "productName": "一个香水", "yData": [5.43, null, 2.23, 1.11] }] }] };
        this.state.xData = xData;
        this.loadScript(productNameList[0]);
        this.state.selectList = productNameList;
        this.state.filteredSelectList = this.state.selectList;
        this.setState({});
      }


      loadScript(productName) {
        var script = document.createElement('script');
        script.src = `./data/${productName}.js`;
        script.type = 'text/javascript';
        script.onload = () => {
          this.state.source = window.currentSource;
          this.setState({});
        };
        document.head.appendChild(script);
      }


      clickInput = () => {
        this.state.showOptions = true;
        this.setState({});
      };


      changeInput = (event) => {
        let value = event.target.value;
        this.state.inputValue = value;
        let newFilteredOptions = this.state.selectList.filter(option => option.includes(value));
        this.state.filteredSelectList = newFilteredOptions;
        this.setState({});
      };



      changeSelect(event) {
        let value = event.target.value;
        this.state.inputValue = value;
        this.state.titleKey = this.state.inputValue;
        this.state.showOptions = false;
        // titleKey找到具体该产品在哪个文件中，定位对应的resource
        this.loadScript(this.state.titleKey);
        this.setState({});
      };


      clickButton(event) {
        this.state.showOptions = false;
        this.state.showCharts = true;
        this.loadScript(this.state.titleKey);
        this.setState({});
      };


      renderCharts() {
        if (this.state.showCharts && this.state.titleKey && this.state.source && this.state.source.length > 0) {
          this.state.yData_jiaGuo = [];
          const jiaGuoSource = this.state.source.find(source => source.sourceName === "jiaGuo");
          if (jiaGuoSource) {
            for (const product of jiaGuoSource.sourceData) {
              // 如果 productName 匹配，返回对应的 yData
              if (product.productName === this.state.titleKey) {
                this.state.yData_jiaGuo = product.yData;
                break;
              }
            }
          }


          this.state.yData_xiaoChen = [];
          const xiaoChenSource = this.state.source.find(source => source.sourceName === "xiaoChen");
          if (xiaoChenSource) {
            for (const product of xiaoChenSource.sourceData) {
              // 如果 productName 匹配，返回对应的 yData
              if (product.productName === this.state.titleKey) {
                this.state.yData_xiaoChen = product.yData;
                break;
              }
            }
          }

          let chartDom = document.getElementById('chart_div');
          let myChart = echarts.init(chartDom);
          let option = {
            title: {
              text: this.state.titleKey
            },
            tooltip: {
              trigger: 'axis'
            },
            legend: {
              data: ["佳锅-" + this.state.titleKey, "小陈-" + this.state.titleKey]
            },
            grid: {
              left: '3%',
              right: '4%',
              bottom: '3%',
              containLabel: true
            },
            xAxis: {
              type: 'category',
              boundaryGap: false,
              data: this.state.xData
            },
            yAxis: {
              type: 'value',
              min: function (value) {
                return Math.floor(value.min - (value.max - value.min) * 0.1);
              }
            },
            dataZoom: [{
              type: 'slider'
            }, {
              type: 'inside'
            }],
            series: [
              {
                name: "佳锅-" + this.state.titleKey,
                type: 'line',
                data: this.state.yData_jiaGuo
              },
              {
                name: "小陈-" + this.state.titleKey,
                type: 'line',
                data: this.state.yData_xiaoChen
              }
            ]
          };
          myChart.setOption(option);
          window.onresize = function () {
            myChart.resize();
          }
        }
      }


      render() {
        return (
          <div >
            <div style={{ display: "table" }}>
              <div style={{ display: "table-cell", width: '300px' }}>
                <input type="text" value={this.state.inputValue} onChange={this.changeInput.bind(this)} onClick={this.clickInput.bind(this)} style={{ width: '100%', padding: '5px' }} />
                {this.state.showOptions && (
                  <select value={this.state.selectedValue} style={{ width: '100%', padding: '5px' }} className="dropdown-menu" onChange={this.changeSelect.bind(this)} size='20'>
                    {this.state.filteredSelectList.map((item, index) => (
                      <option key={index} value={item}>
                        {item}
                      </option>
                    ))}
                  </select>
                )}
              </div>
              <button onClick={this.clickButton.bind(this)} style={{ display: "table-cell", 'margin-left': '20px', border: 'none', 'background-color': '#4CAF50', color: 'white' }}>确认</button>
            </div>
            {true && (
              <div id="chart_div" style={{ width: '100%', height: '400px' }}></div>
            )}

            {this.renderCharts()}
          </div >
        );
      }
    }

    ReactDOM.render(<Dropdown />, document.getElementById('root'));
  </script>
</body>

</html>